# UbicaMe V1 - Sistema Distribuido de Gesti√≥n de Flotas de Transporte

Sistema distribuido de gesti√≥n de flotas de transporte en tiempo real con arquitectura de microservicios, message broker y comunicaci√≥n as√≠ncrona desarrollado para proyecto acad√©mico.

## üèóÔ∏è Arquitectura Distribuida

### üéØ Funcionalidades Implementadas
- ‚úÖ **Event-Driven Architecture** (RabbitMQ)
- ‚úÖ **WebSockets** para tiempo real
- ‚úÖ **Microservicios** independientes y escalables
- ‚úÖ **API Gateway** centralizado
- ‚úÖ **Message Broker** para comunicaci√≥n as√≠ncrona
- ‚úÖ **Notificaciones** push en tiempo real
- ‚úÖ **Cross-service** communication

## üöÄ Tecnolog√≠as Utilizadas

### Backend Distribuido
- **API Gateway**: Express + Socket.IO + HTTP Proxy
- **Microservicios**: Node.js + Express independientes
- **Message Broker**: RabbitMQ para eventos as√≠ncronos
- **Base de datos**: SQLite compartida
- **WebSockets**: Socket.IO para tiempo real
- **Event Bus**: Sistema de eventos personalizado

### Frontend Reactivo
- **Frontend**: React + Socket.IO Client
- **Notificaciones**: React-Toastify
- **Estado en tiempo real**: WebSocket Context
- **Mapas**: OpenStreetMap con Leaflet

## üìÅ Arquitectura del Sistema

```
UbicaMe V1/
‚îú‚îÄ‚îÄ api-gateway/              # API Gateway + WebSockets (Puerto 3000)
‚îÇ   ‚îú‚îÄ‚îÄ server.js            # Proxy y WebSocket server
‚îÇ   ‚îú‚îÄ‚îÄ eventBus.js          # Sistema de eventos RabbitMQ
‚îÇ   ‚îî‚îÄ‚îÄ websocketManager.js  # Gestor de WebSockets
‚îú‚îÄ‚îÄ services/                # Microservicios independientes
‚îÇ   ‚îú‚îÄ‚îÄ auth-service/        # Servicio de autenticaci√≥n (Puerto 3001)
‚îÇ   ‚îú‚îÄ‚îÄ user-service/        # Servicio de usuarios (Puerto 3002)
‚îÇ   ‚îú‚îÄ‚îÄ task-service/        # Servicio de tareas (Puerto 3003)
‚îÇ   ‚îî‚îÄ‚îÄ location-service/    # Servicio de ubicaciones (Puerto 3004)
‚îú‚îÄ‚îÄ backend/                 # Backend compartido (base de datos)
‚îÇ   ‚îú‚îÄ‚îÄ config/             # Configuraci√≥n de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # Rutas con eventos
‚îÇ   ‚îî‚îÄ‚îÄ middleware/         # Autenticaci√≥n y seguridad
‚îú‚îÄ‚îÄ frontend/               # Frontend React (Puerto 4000)
‚îÇ   ‚îú‚îÄ‚îÄ src/context/        # WebSocket y Auth contexts
‚îÇ   ‚îî‚îÄ‚îÄ src/components/     # Componentes reactivos
‚îú‚îÄ‚îÄ install-rabbitmq.ps1   # Instalador autom√°tico de RabbitMQ
‚îú‚îÄ‚îÄ start-distributed-system.ps1  # Iniciador del sistema completo
‚îî‚îÄ‚îÄ stop-system.ps1        # Detenedor del sistema
```

## üîÑ Flujo de Eventos Distribuidos

```mermaid
graph TB
    A[Frontend React] -->|WebSocket| B[API Gateway :3000]
    B -->|HTTP Proxy| C[Auth Service :3001]
    B -->|HTTP Proxy| D[User Service :3002]
    B -->|HTTP Proxy| E[Task Service :3003]
    B -->|HTTP Proxy| F[Location Service :3004]
    
    C -->|Events| G[RabbitMQ Message Broker]
    D -->|Events| G
    E -->|Events| G
    F -->|Events| G
    
    G -->|Notifications| B
    B -->|Real-time| A
    
    C -->|Database| H[SQLite DB]
    D -->|Database| H
    E -->|Database| H
    F -->|Database| H
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Instalar RabbitMQ (Ejecutar como Administrador)
```powershell
# Instalaci√≥n autom√°tica de RabbitMQ
.\install-rabbitmq.ps1
```

### 2. Instalar dependencias del proyecto
```bash
npm install
npm run install-all
```

### 3. Ejecutar el sistema distribuido completo
```powershell
# Inicia todos los microservicios, API Gateway y Frontend
.\start-distributed-system.ps1

# O manualmente para desarrollo
npm run dev
```

### 4. Detener el sistema
```powershell
# Detiene todos los servicios
.\stop-system.ps1
```

## üåê URLs del Sistema Distribuido

### Servicios Principales
- **Frontend React**: http://localhost:4000
- **API Gateway**: http://localhost:3000
- **WebSocket Server**: ws://localhost:3000

### Microservicios (No acceder directamente)
- **Auth Service**: http://localhost:3001
- **User Service**: http://localhost:3002  
- **Task Service**: http://localhost:3003
- **Location Service**: http://localhost:3004

### Herramientas de Monitoreo
- **RabbitMQ Management**: http://localhost:15672 (guest/guest)

## üë• Usuarios por Defecto

### Administrador
- **Email**: admin@ubicame.com
- **Password**: admin123
- **Funciones**: Recibe todas las notificaciones, dashboard en tiempo real

### Conductor de Prueba
- **Email**: driver@ubicame.com  
- **Password**: driver123
- **Funciones**: Notificaciones de tareas, actualizaciones de ubicaci√≥n

## üîå WebSockets y Tiempo Real

### Eventos WebSocket Disponibles
```javascript
// Cliente se conecta autom√°ticamente al autenticarse
socket.on('notification', (data) => {
  // Notificaciones en tiempo real
});

socket.on('location_update', (data) => {
  // Actualizaciones de ubicaci√≥n de conductores
});

socket.on('task_update', (data) => {
  // Actualizaciones de estado de tareas
});

socket.on('dashboard_stats', (data) => {
  // Estad√≠sticas del dashboard en tiempo real
});
```

### Salas de WebSocket
- **`authenticated_users`**: Todos los usuarios autenticados
- **`admins`**: Solo administradores
- **`drivers`**: Solo conductores
- **`driver_{userId}`**: Sala personal de cada conductor

## üì® Sistema de Eventos (RabbitMQ)

### Exchanges Configurados
- **`ubicame.auth`**: Eventos de autenticaci√≥n
- **`ubicame.users`**: Eventos de usuarios
- **`ubicame.tasks`**: Eventos de tareas
- **`ubicame.locations`**: Eventos de ubicaciones
- **`ubicame.notifications`**: Notificaciones push

### Tipos de Eventos
```javascript
// Eventos de usuarios
'user.created' | 'user.updated' | 'user.deleted'

// Eventos de tareas  
'task.created' | 'task.assigned' | 'task.updated' | 'task.completed'

// Eventos de ubicaciones
'location.updated' | 'location.geofence_entered' | 'location.geofence_exited'

// Eventos de autenticaci√≥n
'auth.login' | 'auth.logout' | 'auth.failed_login'

// Notificaciones
'notification.user_update' | 'notification.task_assigned' | 'notification.broadcast'
```

## üìä API Endpoints (Via API Gateway)

### Health Checks
- `GET /health` - Estado del API Gateway
- `GET /api/health/services` - Estado de todos los microservicios

### Autenticaci√≥n (Auth Service)
- `POST /api/auth/login` - Iniciar sesi√≥n + eventos
- `GET /api/auth/verify` - Verificar token

### Usuarios (User Service)
- `GET /api/users` - Listar usuarios + eventos
- `POST /api/users` - Crear usuario + notificaci√≥n
- `PUT /api/users/:id` - Actualizar + evento + notificaci√≥n
- `DELETE /api/users/:id` - Eliminar + evento

### Tareas (Task Service)  
- `GET /api/tasks` - Listar tareas
- `POST /api/tasks` - Crear + asignar + notificar conductor
- `PUT /api/tasks/:id` - Actualizar + eventos + notificaciones
- `GET /api/tasks/stats` - Estad√≠sticas en tiempo real

### Ubicaciones (Location Service)
- `POST /api/locations` - Actualizar + broadcast tiempo real
- `GET /api/locations/drivers` - Ubicaciones actuales

## üéØ Caracter√≠sticas del Sistema Distribuido

### Event-Driven Architecture
- **Comunicaci√≥n as√≠ncrona** entre microservicios
- **Desacoplamiento** total de servicios
- **Escalabilidad** independiente por servicio
- **Tolerancia a fallos** con modo degradado

### WebSockets en Tiempo Real
- **Autenticaci√≥n JWT** en WebSockets
- **Notificaciones push** autom√°ticas
- **Actualizaciones de ubicaci√≥n** en vivo
- **Dashboard reactivo** para admins

### Microservicios Independientes
- **Base de datos compartida** SQLite
- **EventBus distribuido** con RabbitMQ
- **Health checks** individuales
- **Logging y monitoreo** por servicio

### API Gateway Inteligente
- **Proxy HTTP** a microservicios
- **WebSocket server** centralizado
- **Event aggregation** y routing
- **Rate limiting** y seguridad

## üõ†Ô∏è Comandos de Desarrollo

### Desarrollo Individual
```bash
# API Gateway √∫nicamente
cd api-gateway && npm run dev

# Microservicio espec√≠fico
cd services/auth-service && npm run dev
cd services/user-service && npm run dev
cd services/task-service && npm run dev
cd services/location-service && npm run dev

# Frontend √∫nicamente  
cd frontend && npm start
```

### Verificaci√≥n del Sistema
```bash
# Health check general
curl http://localhost:3000/health

# Estados de microservicios
curl http://localhost:3000/api/health/services

# Probar login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@ubicame.com","password":"admin123"}'
```

## üîç Monitoreo y Logs

### RabbitMQ Management
- **URL**: http://localhost:15672
- **Usuario**: guest / **Password**: guest
- **Funciones**: Ver exchanges, colas, mensajes en tiempo real

### Logs del Sistema
- **API Gateway**: Requests HTTP + WebSocket connections
- **Auth Service**: Login attempts + JWT operations  
- **User Service**: CRUD operations + events
- **Task Service**: Task lifecycle + notifications
- **Location Service**: GPS updates + real-time broadcast

### Eventos en Tiempo Real
- **RabbitMQ Events**: Visible en management UI
- **WebSocket Connections**: Logs en API Gateway
- **Database Operations**: Logs en cada microservicio

## üöÄ Ventajas de la Arquitectura Distribuida

### Escalabilidad
- ‚úÖ **Microservicios independientes** escalables por separado
- ‚úÖ **Message broker** maneja picos de carga
- ‚úÖ **WebSockets** eficientes para tiempo real
- ‚úÖ **API Gateway** como punto √∫nico de entrada

### Confiabilidad  
- ‚úÖ **Modo degradado** sin RabbitMQ
- ‚úÖ **Health checks** autom√°ticos
- ‚úÖ **Tolerancia a fallos** por servicio
- ‚úÖ **Reconnection** autom√°tica de WebSockets

### Mantenibilidad
- ‚úÖ **Separaci√≥n de responsabilidades** clara
- ‚úÖ **Event sourcing** para auditabilidad  
- ‚úÖ **Logs distribuidos** con contexto
- ‚úÖ **Testing independiente** por servicio

## üì± Funcionalidades en Tiempo Real

### Para Administradores
- üî¥ **Dashboard en vivo** con estad√≠sticas actualizadas
- üìç **Ubicaciones de conductores** en tiempo real en mapa
- üîî **Notificaciones push** de todas las actividades
- üìä **M√©tricas del sistema** actualizadas autom√°ticamente

### Para Conductores
- üì≤ **Notificaciones de tareas** asignadas instant√°neamente
- üó∫Ô∏è **Ubicaci√≥n autom√°tica** cada 10 segundos v√≠a WebSocket
- ‚úÖ **Actualizaciones de estado** reflejadas al instante
- üîÑ **Sincronizaci√≥n** autom√°tica con el dashboard admin

## üîß Soluci√≥n de Problemas

### RabbitMQ no disponible
```
‚ö†Ô∏è Continuando sin RabbitMQ (modo degradado)
```
- **Soluci√≥n**: Ejecutar `.\install-rabbitmq.ps1` como administrador
- **Alternativa**: Sistema funciona sin eventos distribuidos

### WebSocket desconectado
```
‚ùå WebSocket desconectado  
üîÑ Intentando reconectar...
```
- **Soluci√≥n**: Autom√°tica, reinicio del API Gateway si persiste

### Microservicio no responde
- **Verificar**: `http://localhost:3000/api/health/services`
- **Soluci√≥n**: Reiniciar con `.\start-distributed-system.ps1`

¬°El sistema distribuido UbicaMe est√° listo para producci√≥n acad√©mica! üéâ

## üìû Soporte

Para soporte t√©cnico o consultas sobre la arquitectura distribuida, revisar:
- **Logs del API Gateway** para problemas de conectividad
- **RabbitMQ Management UI** para eventos fallidos  
- **Health checks** para estado de microservicios
- **Console del navegador** para errores de WebSocket

## üó∫Ô∏è Mapas y Ubicaci√≥n

- Utiliza **OpenStreetMap** (gratuito, sin necesidad de API keys)
- Librer√≠a **Leaflet** para interactividad
- Marcadores personalizados para conductores y tareas
- Actualizaci√≥n en tiempo real de posiciones
- Vista adaptativa seg√∫n ubicaciones activas

## üõ†Ô∏è Desarrollo

El proyecto est√° configurado para desarrollo acad√©mico con:
- Base de datos SQLite (archivo local)
- Datos de prueba preconfigurados
- Interfaz intuitiva y responsive
- Actualizaci√≥n en tiempo real
- Mapas gratuitos sin limitaciones

## üìù Caracter√≠sticas T√©cnicas

- **Mapas**: OpenStreetMap + Leaflet (sin costo, sin l√≠mites)
- **Base de datos**: SQLite para simplicidad
- **Autenticaci√≥n**: JWT con expiraci√≥n configurable
- **Tiempo real**: Polling cada 10 segundos
- **Responsive**: Adaptado para m√≥viles y desktop
- **Seguridad**: Rate limiting y validaci√≥n de datos

## üîß Ventajas de OpenStreetMap

- ‚úÖ **Completamente gratuito**
- ‚úÖ **Sin l√≠mites de uso**
- ‚úÖ **No requiere API keys**
- ‚úÖ **Datos actualizados por la comunidad**
- ‚úÖ **Excelente cobertura global**
- ‚úÖ **M√∫ltiples estilos de mapa disponibles**

## üì± Compatibilidad

- ‚úÖ Chrome, Firefox, Safari, Edge
- ‚úÖ Dispositivos m√≥viles iOS/Android
- ‚úÖ Tablets y desktop
- ‚úÖ Responsive design

¬°El sistema est√° listo para usar sin configuraci√≥n adicional de mapas! üéâ 